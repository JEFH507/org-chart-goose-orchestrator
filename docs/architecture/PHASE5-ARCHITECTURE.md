# Phase 5 Architecture â€” Org-Chart Goose Orchestrator

**Date:** 2025-11-06  
**Version:** v0.5.0  
**Status:** Production-Ready (Dev Mode)

This document provides comprehensive architectural views of the Phase 5 system, showing all users, UIs, middleware, controller, and data flows.

---

## ğŸ“‹ Table of Contents

1. [System Overview](#system-overview)
2. [View 1: Complete System Architecture](#view-1-complete-system-architecture)
3. [View 2: User Workflows by Role](#view-2-user-workflows-by-role)
4. [View 3: Data Flow - Profile Loading](#view-3-data-flow---profile-loading)
5. [View 4: Data Flow - Profile Publishing with Vault](#view-4-data-flow---profile-publishing-with-vault)
6. [Component Details](#component-details)
7. [API Endpoint Summary](#api-endpoint-summary)
8. [Security Architecture](#security-architecture)
9. [Phase 6 Preview](#phase-6-preview)

---

## System Overview

**Phase 5 Capabilities:**
- âœ… **Role-Based Profiles**: 6 pre-configured roles (finance, legal, developer, hr, executive, support)
- âœ… **Organizational Chart Management**: CSV import, hierarchical tree API
- âœ… **Vault Integration**: HMAC profile signing (dev mode, production path documented)
- âœ… **Profile Configuration Generation**: Dynamic config.yaml, goosehints, gooseignore
- âœ… **JWT Authentication**: Keycloak OIDC integration with role extraction
- âœ… **Privacy Guard**: Local PII masking (Phase 2, integrated)

**Deployment Mode:**
- Development (current): HTTP, root token, in-memory storage
- Production (Phase 6): HTTPS, AppRole, persistent storage, audit logging

---

## View 1: Complete System Architecture

### Full System Topology

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ENTERPRISE USERS                                  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Finance    â”‚  â”‚    Legal     â”‚  â”‚  Developer   â”‚  â”‚      HR      â”‚  â”‚
â”‚  â”‚    User      â”‚  â”‚    User      â”‚  â”‚    User      â”‚  â”‚    User      â”‚  â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚  â”‚
â”‚  â”‚ Profile:     â”‚  â”‚ Profile:     â”‚  â”‚ Profile:     â”‚  â”‚ Profile:     â”‚  â”‚
â”‚  â”‚ finance      â”‚  â”‚ legal        â”‚  â”‚ developer    â”‚  â”‚ hr           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                  â”‚                  â”‚                  â”‚          â”‚
â”‚         â”‚                  â”‚                  â”‚                  â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚                  â”‚
          â”‚                  â†“                  â”‚                  â”‚
          â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚                  â”‚
          â”‚         â”‚   ADMIN USER   â”‚          â”‚                  â”‚
          â”‚         â”‚   (IT/Admin)   â”‚          â”‚                  â”‚
          â”‚         â”‚                â”‚          â”‚                  â”‚
          â”‚         â”‚  Manages:      â”‚          â”‚                  â”‚
          â”‚         â”‚  - Profiles    â”‚          â”‚                  â”‚
          â”‚         â”‚  - Org Chart   â”‚          â”‚                  â”‚
          â”‚         â”‚  - Publishing  â”‚          â”‚                  â”‚
          â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚                  â”‚
          â”‚                 â”‚                   â”‚                  â”‚
          â†“                 â†“                   â†“                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              USER INTERFACES                                â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      GOOSE DESKTOP APP           â”‚  â”‚    ADMIN WEB UI (Phase 6)    â”‚   â”‚
â”‚  â”‚      (Open Source v1.12)         â”‚  â”‚    (SvelteKit - Planned)     â”‚   â”‚
â”‚  â”‚                                  â”‚  â”‚                              â”‚   â”‚
â”‚  â”‚  Features:                       â”‚  â”‚  Features:                   â”‚   â”‚
â”‚  â”‚  â€¢ Chat interface                â”‚  â”‚  â€¢ Dashboard (D3.js)         â”‚   â”‚
â”‚  â”‚  â€¢ MCP extensions                â”‚  â”‚  â€¢ Profile editor (Monaco)   â”‚   â”‚
â”‚  â”‚  â€¢ Provider management           â”‚  â”‚  â€¢ Org chart manager (CSV)   â”‚   â”‚
â”‚  â”‚  â€¢ Session history               â”‚  â”‚  â€¢ Audit logs (table)        â”‚   â”‚
â”‚  â”‚  â€¢ Profile-based config          â”‚  â”‚  â€¢ User sessions (live)      â”‚   â”‚
â”‚  â”‚                                  â”‚  â”‚  â€¢ Vault status              â”‚   â”‚
â”‚  â”‚  Auto-configured from:           â”‚  â”‚                              â”‚   â”‚
â”‚  â”‚  ~/.config/goose/config.yaml     â”‚  â”‚  Authenticated via:          â”‚   â”‚
â”‚  â”‚  ~/.config/goose/.goosehints     â”‚  â”‚  Keycloak OIDC (admin role)  â”‚   â”‚
â”‚  â”‚  ~/.config/goose/.gooseignore    â”‚  â”‚                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                  â”‚                                   â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                                   â”‚
                   â”‚                                   â”‚
                   â†“                                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AUTHENTICATION LAYER                                â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    KEYCLOAK (OIDC Provider)                          â”‚ â”‚
â”‚  â”‚                    Port: 8080 | Realm: dev                           â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  Flows:                                                              â”‚ â”‚
â”‚  â”‚  1. User Login â†’ Password Grant â†’ JWT Token                         â”‚ â”‚
â”‚  â”‚  2. Token contains claims: {sub, email, roles: ["finance"]}         â”‚ â”‚
â”‚  â”‚  3. Controller extracts role from JWT for profile lookup            â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  Users Configured:                                                   â”‚ â”‚
â”‚  â”‚  â€¢ testuser / testpassword (finance role)                           â”‚ â”‚
â”‚  â”‚  â€¢ admin@example.com (admin role)                                   â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  Clients:                                                            â”‚ â”‚
â”‚  â”‚  â€¢ goose-controller (backend client)                                â”‚ â”‚
â”‚  â”‚  â€¢ admin-ui (frontend client, Phase 6)                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â†“ JWT Token (Bearer)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MIDDLEWARE LAYER                                    â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚               PRIVACY GUARD MCP (Phase 2 - Integrated)               â”‚ â”‚
â”‚  â”‚               Port: 8089 | Language: Rust                            â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  Capabilities:                                                       â”‚ â”‚
â”‚  â”‚  â€¢ PII Detection: 8 entity types (SSN, Email, Phone, CC, etc.)      â”‚ â”‚
â”‚  â”‚  â€¢ Masking: Deterministic HMAC-SHA256 pseudonymization              â”‚ â”‚
â”‚  â”‚  â€¢ Format-Preserving: Phone/SSN maintain format                     â”‚ â”‚
â”‚  â”‚  â€¢ Performance: P50=16ms, P95=22ms                                  â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  Endpoints:                                                          â”‚ â”‚
â”‚  â”‚  â€¢ POST /guard/scan       â†’ Detect PII entities                     â”‚ â”‚
â”‚  â”‚  â€¢ POST /guard/mask       â†’ Mask PII (forward to LLM)               â”‚ â”‚
â”‚  â”‚  â€¢ POST /guard/reidentify â†’ Restore original PII                    â”‚ â”‚
â”‚  â”‚  â€¢ GET  /guard/status     â†’ Health check                            â”‚ â”‚
â”‚  â”‚  â€¢ POST /guard/flush      â†’ Clear session tokens                    â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  Privacy Flow:                                                       â”‚ â”‚
â”‚  â”‚  User Text â†’ Scan â†’ Mask â†’ LLM (masked) â†’ Response â†’ Unmask â†’ User  â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  Storage:                                                            â”‚ â”‚
â”‚  â”‚  â€¢ Local tokens: ~/.goose/pii-tokens/ (ephemeral)                   â”‚ â”‚
â”‚  â”‚  â€¢ No cloud storage (privacy-first)                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ORCHESTRATION LAYER                                  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                 CONTROLLER API (Rust/Axum)                           â”‚ â”‚
â”‚  â”‚                 Port: 8088 | Language: Rust                          â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  PROFILE ENDPOINTS (Workstream D)                              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  User Endpoints (Authenticated):                               â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ GET /profiles/{role}                â†’ Full profile JSON     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ GET /profiles/{role}/config         â†’ config.yaml          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ GET /profiles/{role}/goosehints     â†’ .goosehints          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ GET /profiles/{role}/goosehints/local â†’ Local hints        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ GET /profiles/{role}/gooseignore    â†’ .gooseignore         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ GET /profiles/{role}/recipes        â†’ Recipe list          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Admin Endpoints (Admin role required):                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ POST /admin/profiles                â†’ Create profile        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ PUT  /admin/profiles/{role}         â†’ Update profile        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ POST /admin/profiles/{role}/publish â†’ Sign with Vault       â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  ORG CHART ENDPOINTS (Workstream E)                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Admin Endpoints:                                              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ POST /admin/org/import  â†’ Upload CSV (bulk insert)         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ GET  /admin/org/imports â†’ Import history + audit           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ GET  /admin/org/tree    â†’ Hierarchical org structure       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  CSV Format:                                                   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  employee_id,email,name,manager_email,department,title        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Tree Output: Nested JSON (manager â†’ [reports])               â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  INFRASTRUCTURE ENDPOINTS                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ GET  /status           â†’ Health check                       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ POST /audit/ingest     â†’ Audit log ingestion (Phase 1)     â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  Middleware:                                                         â”‚ â”‚
â”‚  â”‚  â€¢ JWT Verification (RS256 + JWKS from Keycloak)                   â”‚ â”‚
â”‚  â”‚  â€¢ Role Extraction (from JWT claims)                                â”‚ â”‚
â”‚  â”‚  â€¢ Request Logging (structured, PII-redacted)                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                                   â”‚
              â†“                                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    VAULT (HMAC Signing)      â”‚   â”‚       POSTGRESQL DATABASE                â”‚
â”‚    Port: 8200 (HTTP)         â”‚   â”‚       Port: 5432                         â”‚
â”‚    Mode: Dev (Phase 5)       â”‚   â”‚                                          â”‚
â”‚                              â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  Transit Engine:             â”‚   â”‚  â”‚  profiles (JSONB storage)          â”‚  â”‚
â”‚  â€¢ Key: profile-signing      â”‚   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â€¢ Algorithm: HMAC-SHA256    â”‚   â”‚  â”‚  â”‚ role VARCHAR(255) PK         â”‚  â”‚  â”‚
â”‚  â€¢ Operations: sign, verify  â”‚   â”‚  â”‚  â”‚ display_name VARCHAR(255)    â”‚  â”‚  â”‚
â”‚  â”‚                            â”‚   â”‚  â”‚  â”‚ description TEXT             â”‚  â”‚  â”‚
â”‚  Endpoints Used:             â”‚   â”‚  â”‚  â”‚ config JSONB                 â”‚  â”‚  â”‚
â”‚  â€¢ POST /transit/hmac/...    â”‚   â”‚  â”‚  â”‚   â”œâ”€ providers               â”‚  â”‚  â”‚
â”‚  â”‚                            â”‚   â”‚  â”‚  â”‚   â”œâ”€ extensions              â”‚  â”‚  â”‚
â”‚  Signature Format:           â”‚   â”‚  â”‚  â”‚   â”œâ”€ goosehints              â”‚  â”‚  â”‚
â”‚  vault:v1:BASE64_HMAC        â”‚   â”‚  â”‚  â”‚   â”œâ”€ gooseignore             â”‚  â”‚  â”‚
â”‚  â”‚                            â”‚   â”‚  â”‚  â”‚   â”œâ”€ recipes                 â”‚  â”‚  â”‚
â”‚  Environment:                â”‚   â”‚  â”‚  â”‚   â”œâ”€ automated_tasks          â”‚  â”‚  â”‚
â”‚  â€¢ VAULT_ADDR (HTTP)         â”‚   â”‚  â”‚  â”‚   â”œâ”€ policies                â”‚  â”‚  â”‚
â”‚  â€¢ VAULT_TOKEN (root)        â”‚   â”‚  â”‚  â”‚   â”œâ”€ privacy                 â”‚  â”‚  â”‚
â”‚  â”‚                            â”‚   â”‚  â”‚  â”‚   â”œâ”€ env_vars                â”‚  â”‚  â”‚
â”‚  Phase 6 Production:         â”‚   â”‚  â”‚  â”‚   â””â”€ signature (Vault HMAC)  â”‚  â”‚  â”‚
â”‚  â€¢ TLS/HTTPS (2h)            â”‚   â”‚  â”‚  â”‚ created_at TIMESTAMPTZ       â”‚  â”‚  â”‚
â”‚  â€¢ AppRole auth (3h)         â”‚   â”‚  â”‚  â”‚ updated_at TIMESTAMPTZ       â”‚  â”‚  â”‚
â”‚  â€¢ Persistent storage (2h)   â”‚   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â€¢ Audit device (1h)         â”‚   â”‚  â”‚  GIN index on config (JSONB ops)   â”‚  â”‚
â”‚  â€¢ Signature verify (2h)     â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                                          â”‚
                                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                                   â”‚  â”‚  org_users (Org chart)             â”‚  â”‚
                                   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
                                   â”‚  â”‚  â”‚ employee_id VARCHAR(50) PK   â”‚  â”‚  â”‚
                                   â”‚  â”‚  â”‚ email VARCHAR(255) UNIQUE    â”‚  â”‚  â”‚
                                   â”‚  â”‚  â”‚ name VARCHAR(255)            â”‚  â”‚  â”‚
                                   â”‚  â”‚  â”‚ manager_email VARCHAR(255)   â”‚  â”‚  â”‚
                                   â”‚  â”‚  â”‚   (self-referencing FK)      â”‚  â”‚  â”‚
                                   â”‚  â”‚  â”‚ department VARCHAR(255)      â”‚  â”‚  â”‚
                                   â”‚  â”‚  â”‚ title VARCHAR(255)           â”‚  â”‚  â”‚
                                   â”‚  â”‚  â”‚ created_at TIMESTAMPTZ       â”‚  â”‚  â”‚
                                   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
                                   â”‚  â”‚  Indexes:                          â”‚  â”‚
                                   â”‚  â”‚  â€¢ email                           â”‚  â”‚
                                   â”‚  â”‚  â€¢ manager_email                   â”‚  â”‚
                                   â”‚  â”‚  â€¢ department                      â”‚  â”‚
                                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                   â”‚                                          â”‚
                                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                                   â”‚  â”‚  org_imports (Audit trail)         â”‚  â”‚
                                   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
                                   â”‚  â”‚  â”‚ import_id SERIAL PK          â”‚  â”‚  â”‚
                                   â”‚  â”‚  â”‚ filename VARCHAR(255)        â”‚  â”‚  â”‚
                                   â”‚  â”‚  â”‚ rows_imported INT            â”‚  â”‚  â”‚
                                   â”‚  â”‚  â”‚ imported_by VARCHAR(255)     â”‚  â”‚  â”‚
                                   â”‚  â”‚  â”‚   (from JWT email)           â”‚  â”‚  â”‚
                                   â”‚  â”‚  â”‚ imported_at TIMESTAMPTZ      â”‚  â”‚  â”‚
                                   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
                                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                   â”‚                                          â”‚
                                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                                   â”‚  â”‚  Legacy Tables (Phase 1-2)         â”‚  â”‚
                                   â”‚  â”‚  â€¢ audit_events (Phase 1)          â”‚  â”‚
                                   â”‚  â”‚  â€¢ sessions (Phase 1)              â”‚  â”‚
                                   â”‚  â”‚  â€¢ privacy_events (Phase 2)        â”‚  â”‚
                                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         EXTERNAL SERVICES                                   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                      CLOUD LLM PROVIDERS                             â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  â€¢ OpenAI (GPT-4, GPT-3.5)                                          â”‚ â”‚
â”‚  â”‚  â€¢ Anthropic (Claude 3.5 Sonnet, Claude 3 Opus)                     â”‚ â”‚
â”‚  â”‚  â€¢ Google (Gemini Pro)                                              â”‚ â”‚
â”‚  â”‚  â€¢ OpenRouter (multi-provider gateway)                              â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  Privacy Protection:                                                 â”‚ â”‚
â”‚  â”‚  All requests pass through Privacy Guard MCP                         â”‚ â”‚
â”‚  â”‚  LLMs receive masked PII only (EMAIL_7a3f9b, not john@acme.com)     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                      LOCAL LLM (OLLAMA)                              â”‚ â”‚
â”‚  â”‚                      Port: 11434                                     â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  Models Available:                                                   â”‚ â”‚
â”‚  â”‚  â€¢ qwen2.5:3b (Privacy Guard NER, Phase 2.2)                        â”‚ â”‚
â”‚  â”‚  â€¢ llama3.2:3b (local inference)                                    â”‚ â”‚
â”‚  â”‚  â€¢ mistral:7b (local inference)                                     â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  Use Case:                                                           â”‚ â”‚
â”‚  â”‚  Legal/Finance profiles can enforce local-only (no cloud PII)       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Architecture Principles:**
1. **Layered Security**: Keycloak â†’ JWT â†’ Controller â†’ Vault â†’ Database
2. **Privacy-First**: All PII passes through Privacy Guard before cloud
3. **Profile-Driven**: User role determines complete Goose configuration
4. **Signature Integrity**: Vault HMAC prevents profile tampering
5. **Org-Aware**: Hierarchical org chart enables future approval workflows

---

## View 2: User Workflows by Role

### 2.1 Finance User Workflow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FINANCE USER: Budget Analysis                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: Authentication
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Finance     â”‚  Login via Keycloak OIDC
â”‚ User        â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ (Desktop)   â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚   Keycloak       â”‚
                                         â”‚   Returns JWT:   â”‚
                                         â”‚   {              â”‚
                                         â”‚     role: "fin"  â”‚
                                         â”‚     email: "..." â”‚
                                         â”‚   }              â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2: Profile Loading
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Goose       â”‚  GET /profiles/finance (with JWT)
â”‚ Desktop     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚  Controller      â”‚
                                         â”‚  1. Verify JWT   â”‚
                                         â”‚  2. Extract role â”‚
                                         â”‚  3. Query DB     â”‚
                                         â”‚  4. Return JSON  â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚  Profile JSON:   â”‚
                                         â”‚  {               â”‚
                                         â”‚    providers: {  â”‚
                                         â”‚      primary:    â”‚
                                         â”‚       "claude-3.5â”‚
                                         â”‚        -sonnet"  â”‚
                                         â”‚    },            â”‚
                                         â”‚    extensions: [ â”‚
                                         â”‚      {name:      â”‚
                                         â”‚       "github"}  â”‚
                                         â”‚    ],            â”‚
                                         â”‚    privacy: {    â”‚
                                         â”‚      mode:       â”‚
                                         â”‚       "strict"   â”‚
                                         â”‚    }             â”‚
                                         â”‚  }               â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 3: Configuration Generation
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Goose       â”‚  GET /profiles/finance/config
â”‚ Desktop     â”‚  GET /profiles/finance/goosehints
â”‚             â”‚  GET /profiles/finance/gooseignore
â”‚             â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
                                                   â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚  Controller      â”‚
                                         â”‚  Generates:      â”‚
                                         â”‚  â€¢ config.yaml   â”‚
                                         â”‚  â€¢ .goosehints   â”‚
                                         â”‚  â€¢ .gooseignore  â”‚
                                         â”‚  from profile    â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Local       â”‚  Saves to:             â”‚  Files:          â”‚
â”‚ Filesystem  â”‚  ~/.config/goose/      â”‚  â€¢ config.yaml   â”‚
â”‚             â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â€¢ .goosehints    â”‚
â”‚             â”‚                         â”‚  â€¢ .gooseignore  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 4: Task Execution (with Privacy Guard)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User types: â”‚  "Analyze Q4 budget for john.doe@acme.com"
â”‚ Goose Chat  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
                                                     â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚ Privacy Guard    â”‚
                                         â”‚ 1. Scan PII:     â”‚
                                         â”‚    EMAIL detectedâ”‚
                                         â”‚ 2. Mask:         â”‚
                                         â”‚    â†’ EMAIL_7a3f9bâ”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚ Claude API       â”‚
                                         â”‚ Receives:        â”‚
                                         â”‚ "Analyze budget  â”‚
                                         â”‚  for EMAIL_7a3f9bâ”‚
                                         â”‚  ..."            â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚ Response:        â”‚
                                         â”‚ "EMAIL_7a3f9b hasâ”‚
                                         â”‚  overspent by 20%â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ Privacy     â”‚  Unmask EMAIL_7a3f9b            â”‚
â”‚ Guard       â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚             â”‚
â”‚ Returns:    â”‚
â”‚ "john.doe@  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  acme.com   â”‚                                   â”‚
â”‚  has over-  â”‚                                   â†“
â”‚  spent by   â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  20%"       â”‚                         â”‚  User sees       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚  original text   â”‚
                                        â”‚  (unmasked)      â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Profile Features Applied:
âœ… Primary provider: Claude 3.5 Sonnet (from finance profile)
âœ… Extensions: github (budget tracking in GitHub issues)
âœ… Privacy: Strict PII protection (EMAIL masked before cloud)
âœ… Goosehints: Finance-specific prompts ("Always show currency")
âœ… Gooseignore: Protects .env files, secrets
```

---

### 2.2 Legal User Workflow (Local-Only Enforcement)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                LEGAL USER: Contract Review (Attorney-Client Privilege)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: Profile Loading
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Legal User  â”‚  GET /profiles/legal (JWT)
â”‚ Desktop     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
                                                   â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚  Profile JSON:   â”‚
                                         â”‚  {               â”‚
                                         â”‚    providers: {  â”‚
                                         â”‚      primary:    â”‚
                                         â”‚       "ollama/   â”‚
                                         â”‚        llama3.2" â”‚
                                         â”‚      forbidden:  â”‚
                                         â”‚       ["openai", â”‚
                                         â”‚        "anthro"] â”‚
                                         â”‚    },            â”‚
                                         â”‚    privacy: {    â”‚
                                         â”‚      local_only: â”‚
                                         â”‚       true,      â”‚
                                         â”‚      retention:  â”‚
                                         â”‚       0          â”‚
                                         â”‚    },            â”‚
                                         â”‚    policies: [   â”‚
                                         â”‚      {deny_tool: â”‚
                                         â”‚       "developer_â”‚
                                         â”‚        _shell"}  â”‚
                                         â”‚    ]             â”‚
                                         â”‚  }               â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2: Task Execution (Local Only)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User types: â”‚  "Review contract for Acme Corp, CEO John Doe"
â”‚ Goose Chat  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
                                                     â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚ Privacy Guard    â”‚
                                         â”‚ Policy:          â”‚
                                         â”‚ local_only=true  â”‚
                                         â”‚                  â”‚
                                         â”‚ 1. Scan PII:     â”‚
                                         â”‚    PERSON, ORG   â”‚
                                         â”‚ 2. Mask locally  â”‚
                                         â”‚ 3. Block cloud   â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚ Ollama (Local)   â”‚
                                         â”‚ Model: llama3.2  â”‚
                                         â”‚ Receives:        â”‚
                                         â”‚ "Review contract â”‚
                                         â”‚  for ORG_A,      â”‚
                                         â”‚  CEO PERSON_B"   â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚ Response:        â”‚
                                         â”‚ "ORG_A contract  â”‚
                                         â”‚  complies with   â”‚
                                         â”‚  terms. PERSON_B â”‚
                                         â”‚  signature req." â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Privacy     â”‚  Unmask locally        â”‚  User sees:      â”‚
â”‚ Guard       â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  "Acme Corp      â”‚
â”‚             â”‚                         â”‚   contract ok.   â”‚
â”‚             â”‚                         â”‚   John Doe sign  â”‚
â”‚             â”‚                         â”‚   required."     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Privacy Guarantees:
âœ… No cloud provider used (Ollama local only)
âœ… PII masked even for local model (defense in depth)
âœ… Memory retention: 0 days (ephemeral)
âœ… Code execution blocked (deny_tool: "developer__shell")
âœ… Attorney-client privilege protected

Phase 6 Enhancement:
â³ Real-time enforcement: Block cloud API calls at network level
â³ Admin audit: Log all local-only profile usage
```

---

### 2.3 Admin Workflow: Profile Publishing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               ADMIN WORKFLOW: Create and Publish Profile              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: Create Profile (D7)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Admin       â”‚  POST /admin/profiles
â”‚ (Web UI or  â”‚  Authorization: Bearer <JWT with admin role>
â”‚  curl)      â”‚  Content-Type: application/json
â”‚             â”‚  
â”‚             â”‚  {
â”‚             â”‚    "role": "finance",
â”‚             â”‚    "display_name": "Finance Manager",
â”‚             â”‚    "description": "Budget analysis",
â”‚             â”‚    "providers": {
â”‚             â”‚      "primary": "claude-3.5-sonnet"
â”‚             â”‚    },
â”‚             â”‚    "privacy": {
â”‚             â”‚      "mode": "strict"
â”‚             â”‚    }
â”‚             â”‚  }
â”‚             â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
                                                   â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚  Controller      â”‚
                                         â”‚  1. Verify JWT   â”‚
                                         â”‚  2. Check role=  â”‚
                                         â”‚     admin        â”‚
                                         â”‚  3. Validate     â”‚
                                         â”‚     schema       â”‚
                                         â”‚  4. Insert DB    â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚  PostgreSQL      â”‚
                                         â”‚  INSERT INTO     â”‚
                                         â”‚  profiles        â”‚
                                         â”‚  (role, config)  â”‚
                                         â”‚  VALUES          â”‚
                                         â”‚  ('finance',     â”‚
                                         â”‚   {...})         â”‚
                                         â”‚                  â”‚
                                         â”‚  signature: NULL â”‚
                                         â”‚  (unsigned)      â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2: Update Profile (D8)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Admin       â”‚  PUT /admin/profiles/finance
â”‚             â”‚  Authorization: Bearer <JWT>
â”‚             â”‚  
â”‚             â”‚  {
â”‚             â”‚    "privacy": {
â”‚             â”‚      "retention_days": 30
â”‚             â”‚    }
â”‚             â”‚  }
â”‚             â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
                                                   â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚  Controller      â”‚
                                         â”‚  1. Fetch profileâ”‚
                                         â”‚  2. Merge JSON   â”‚
                                         â”‚     (partial     â”‚
                                         â”‚      update)     â”‚
                                         â”‚  3. Update DB    â”‚
                                         â”‚  4. Clear sig    â”‚
                                         â”‚     (invalidate) â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚  PostgreSQL      â”‚
                                         â”‚  UPDATE profiles â”‚
                                         â”‚  SET config =    â”‚
                                         â”‚    merge(old,new)â”‚
                                         â”‚      signature = â”‚
                                         â”‚       NULL       â”‚
                                         â”‚  WHERE role =    â”‚
                                         â”‚   'finance'      â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 3: Publish Profile (D9 - Vault Signing)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Admin       â”‚  POST /admin/profiles/finance/publish
â”‚             â”‚  Authorization: Bearer <JWT>
â”‚             â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
                                                   â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚  Controller      â”‚
                                         â”‚  Publish Flow:   â”‚
                                         â”‚                  â”‚
                                         â”‚  1. Fetch profileâ”‚
                                         â”‚     from DB      â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚  2. Serialize    â”‚
                                         â”‚     to JSON      â”‚
                                         â”‚     (canonical)  â”‚
                                         â”‚                  â”‚
                                         â”‚  sorted_json =   â”‚
                                         â”‚  serde_json::to_ â”‚
                                         â”‚  string_pretty   â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚  3. Send to Vaultâ”‚
                                         â”‚                  â”‚
                                         â”‚  POST /v1/transitâ”‚
                                         â”‚  /hmac/profile-  â”‚
                                         â”‚  signing/sha2-256â”‚
                                         â”‚                  â”‚
                                         â”‚  {input: BASE64} â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚  Vault Transit   â”‚
                                         â”‚  Engine          â”‚
                                         â”‚                  â”‚
                                         â”‚  1. Decode BASE64â”‚
                                         â”‚  2. Compute HMAC-â”‚
                                         â”‚     SHA256 with  â”‚
                                         â”‚     key          â”‚
                                         â”‚  3. Return sig   â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚  Response:       â”‚
                                         â”‚  {               â”‚
                                         â”‚    signature:    â”‚
                                         â”‚    "vault:v1:    â”‚
                                         â”‚     6wmfS0Vo91Ga0â”‚
                                         â”‚     E9BkInhWZvLJ3â”‚
                                         â”‚     qQodEnXhykdyâ”‚
                                         â”‚     wB8kc="      â”‚
                                         â”‚  }               â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚  Controller      â”‚
                                         â”‚  4. Build sig    â”‚
                                         â”‚     metadata     â”‚
                                         â”‚                  â”‚
                                         â”‚  signature = {   â”‚
                                         â”‚    algorithm:    â”‚
                                         â”‚     "sha2-256",  â”‚
                                         â”‚    vault_key:    â”‚
                                         â”‚     "transit/...",
                                         â”‚    signed_at:    â”‚
                                         â”‚     "2025-11-06",â”‚
                                         â”‚    signed_by:    â”‚
                                         â”‚     "admin@...", â”‚
                                         â”‚    signature:    â”‚
                                         â”‚     "vault:v1:..."
                                         â”‚  }               â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚  5. Update DB    â”‚
                                         â”‚                  â”‚
                                         â”‚  UPDATE profiles â”‚
                                         â”‚  SET config =    â”‚
                                         â”‚   jsonb_set(     â”‚
                                         â”‚     config,      â”‚
                                         â”‚     '{signature}'â”‚
                                         â”‚     signature    â”‚
                                         â”‚   )              â”‚
                                         â”‚  WHERE role =    â”‚
                                         â”‚   'finance'      â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚  Response:       â”‚
                                         â”‚  {               â”‚
                                         â”‚    message:      â”‚
                                         â”‚     "Published", â”‚
                                         â”‚    signature: {  â”‚
                                         â”‚      ...         â”‚
                                         â”‚    }             â”‚
                                         â”‚  }               â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Signature Benefits:
âœ… Tamper detection: Any manual DB edit invalidates signature
âœ… Integrity: Vault key protection (Phase 6: AppRole + Raft storage)
âœ… Audit: Signed by whom, when (metadata stored in profile)
âœ… Verification: Phase 6 adds verify on load (reject if invalid)

Phase 6 Production Upgrade:
â³ TLS/HTTPS (VAULT_ADDR = https://vault:8200)
â³ AppRole authentication (remove VAULT_TOKEN)
â³ Persistent Raft storage (unseal procedure)
â³ File audit device (/vault/logs)
â³ Signature verification on profile load (403 if tampered)
```

---

### 2.4 Developer User Workflow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DEVELOPER USER: Code Review with Tools                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: Profile Loading
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Developer   â”‚  GET /profiles/developer (JWT)
â”‚ User        â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
                                                   â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚  Profile JSON:   â”‚
                                         â”‚  {               â”‚
                                         â”‚    providers: {  â”‚
                                         â”‚      primary:    â”‚
                                         â”‚       "gpt-4o",  â”‚
                                         â”‚      worker:     â”‚
                                         â”‚       "gpt-4o-   â”‚
                                         â”‚        mini"     â”‚
                                         â”‚    },            â”‚
                                         â”‚    extensions: [ â”‚
                                         â”‚      {name:      â”‚
                                         â”‚       "github"}, â”‚
                                         â”‚      {name:      â”‚
                                         â”‚       "developer"â”‚
                                         â”‚        tools: [  â”‚
                                         â”‚         "shell", â”‚
                                         â”‚         "analyze"â”‚
                                         â”‚        ]}        â”‚
                                         â”‚    ],            â”‚
                                         â”‚    policies: [   â”‚
                                         â”‚      {allow_tool:â”‚
                                         â”‚       "developer_â”‚
                                         â”‚        _shell"}  â”‚
                                         â”‚    ],            â”‚
                                         â”‚    goosehints: { â”‚
                                         â”‚      global:     â”‚
                                         â”‚       "Use TDD"  â”‚
                                         â”‚    }             â”‚
                                         â”‚  }               â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2: Task Execution (with MCP Tools)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User types: â”‚  "Review PR #123 from repo finance-api"
â”‚ Goose Chat  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
                                                     â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚ Goose Engine     â”‚
                                         â”‚ 1. Parse intent  â”‚
                                         â”‚ 2. Check policy  â”‚
                                         â”‚    (allow github)â”‚
                                         â”‚ 3. Call MCP tool â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚ GitHub MCP       â”‚
                                         â”‚ Extension        â”‚
                                         â”‚                  â”‚
                                         â”‚ GET /repos/      â”‚
                                         â”‚  finance-api/    â”‚
                                         â”‚  pulls/123       â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚ PR Data:         â”‚
                                         â”‚ â€¢ Files changed  â”‚
                                         â”‚ â€¢ Commits        â”‚
                                         â”‚ â€¢ Comments       â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚ Goose sends to   â”‚
                                         â”‚ GPT-4o:          â”‚
                                         â”‚                  â”‚
                                         â”‚ "Review this PR: â”‚
                                         â”‚  [diff content]  â”‚
                                         â”‚  Context: TDD    â”‚
                                         â”‚  (from hints)"   â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response:   â”‚                        â”‚ GPT-4o:          â”‚
â”‚ "PR #123    â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ "LGTM. Tests passâ”‚
â”‚  approved.  â”‚                         â”‚  Code follows    â”‚
â”‚  Suggest    â”‚                         â”‚  TDD. Suggest    â”‚
â”‚  merge."    â”‚                         â”‚  merge."         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Profile Features Applied:
âœ… Primary: GPT-4o (complex analysis)
âœ… Worker: GPT-4o-mini (simple summaries)
âœ… Extensions: github (PR access), developer tools (shell, analyze)
âœ… Policies: allow_tool "developer__shell" (can run git commands)
âœ… Goosehints: "Use TDD" (injected into prompts)
âœ… Privacy: Standard (mask PII in PR comments if detected)

Phase 3 Multi-Agent Enhancement:
â³ "Ask Security to review this PR" (route to security profile)
â³ "Request Legal approval for license change"
```

---

## View 3: Data Flow - Profile Loading

### Complete Profile Loading Sequence

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 DATA FLOW: USER LOADS PROFILE                         â”‚
â”‚                 Endpoint: GET /profiles/{role}                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Goose       â”‚  Step 1: Request with JWT
  â”‚  Desktop     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚              â”‚                                            â”‚
  â”‚  Request:    â”‚                                            â”‚
  â”‚  GET /profiles/finance                                   â”‚
  â”‚  Authorization: Bearer eyJhbGc...                         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â†“
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚  Controller        â”‚
                                                   â”‚  Middleware:       â”‚
                                                   â”‚  1. Extract JWT    â”‚
                                                   â”‚     from header    â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          â”‚
                                                          â†“
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚  2. Verify JWT     â”‚
                                                   â”‚     Signature      â”‚
                                                   â”‚                    â”‚
                                                   â”‚  â€¢ Fetch JWKS from â”‚
                                                   â”‚    Keycloak:       â”‚
                                                   â”‚    GET /realms/dev/â”‚
                                                   â”‚    protocol/openid-â”‚
                                                   â”‚    connect/certs   â”‚
                                                   â”‚  â€¢ Verify RS256    â”‚
                                                   â”‚  â€¢ Check exp       â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          â”‚
                                                          â†“
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚  3. Extract Claims â”‚
                                                   â”‚                    â”‚
                                                   â”‚  jwt_claims = {    â”‚
                                                   â”‚    sub: "user-id"  â”‚
                                                   â”‚    email: "john@..." â”‚
                                                   â”‚    roles: ["fin"]  â”‚
                                                   â”‚    exp: 1699999999 â”‚
                                                   â”‚  }                 â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          â”‚
                                                          â†“
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚  4. Match Role     â”‚
                                                   â”‚                    â”‚
                                                   â”‚  requested_role =  â”‚
                                                   â”‚   "finance"        â”‚
                                                   â”‚  user_roles =      â”‚
                                                   â”‚   ["fin", "user"]  â”‚
                                                   â”‚                    â”‚
                                                   â”‚  Mapping:          â”‚
                                                   â”‚  "fin" â†’ "finance" â”‚
                                                   â”‚  "legal" â†’ "legal" â”‚
                                                   â”‚  "dev" â†’ "developerâ”‚
                                                   â”‚                    â”‚
                                                   â”‚  âœ… Authorized     â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          â”‚
                                                          â†“
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚  5. Query Database â”‚
                                                   â”‚                    â”‚
                                                   â”‚  SELECT config     â”‚
                                                   â”‚  FROM profiles     â”‚
                                                   â”‚  WHERE role =      â”‚
                                                   â”‚   'finance'        â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          â”‚
                                                          â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚  PostgreSQL: orchestrator DB    â”‚
                                         â”‚  Table: profiles                â”‚
                                         â”‚                                 â”‚
                                         â”‚  role='finance'                 â”‚
                                         â”‚  data={  â† JSONB column         â”‚
                                         â”‚    "providers": {               â”‚
                                         â”‚      "primary": "claude-3.5-    â”‚
                                         â”‚       sonnet",                  â”‚
                                         â”‚      "planner": "claude-3.5-    â”‚
                                         â”‚       sonnet",                  â”‚
                                         â”‚      "worker": "gpt-4o-mini",   â”‚
                                         â”‚      "allowed_providers": [     â”‚
                                         â”‚        "openai", "anthropic"    â”‚
                                         â”‚      ],                         â”‚
                                         â”‚      "forbidden_providers": [], â”‚
                                         â”‚      "temperature": 0.3         â”‚
                                         â”‚    },                           â”‚
                                         â”‚    "extensions": [              â”‚
                                         â”‚      {                          â”‚
                                         â”‚        "name": "github",        â”‚
                                         â”‚        "tools": ["*"],          â”‚
                                         â”‚        "preferences": {}        â”‚
                                         â”‚      }                          â”‚
                                         â”‚    ],                           â”‚
                                         â”‚    "goosehints": {              â”‚
                                         â”‚      "global": "You are assist...",
                                         â”‚      "local_templates": []      â”‚
                                         â”‚    },                           â”‚
                                         â”‚    "gooseignore": {             â”‚
                                         â”‚      "global": [                â”‚
                                         â”‚        "*.env", "*.key"         â”‚
                                         â”‚      ],                         â”‚
                                         â”‚      "local_templates": []      â”‚
                                         â”‚    },                           â”‚
                                         â”‚    "recipes": [],               â”‚
                                         â”‚    "automated_tasks": [],       â”‚
                                         â”‚    "policies": [                â”‚
                                         â”‚      {                          â”‚
                                         â”‚        "allow_tool": "github__*"â”‚
                                         â”‚        "pattern": "github__*",  â”‚
                                         â”‚        "reason": "Budget track" â”‚
                                         â”‚      }                          â”‚
                                         â”‚    ],                           â”‚
                                         â”‚    "privacy": {                 â”‚
                                         â”‚      "mode": "strict",          â”‚
                                         â”‚      "strictness": "strict",    â”‚
                                         â”‚      "local_only": false,       â”‚
                                         â”‚      "retention_days": 30,      â”‚
                                         â”‚      "pii_rules": [             â”‚
                                         â”‚        {"entity": "SSN",        â”‚
                                         â”‚         "action": "MASK"},      â”‚
                                         â”‚        {"entity": "EMAIL",      â”‚
                                         â”‚         "action": "MASK"}       â”‚
                                         â”‚      ]                          â”‚
                                         â”‚    },                           â”‚
                                         â”‚    "env_vars": {                â”‚
                                         â”‚      "GOOSE_ENV": "production"  â”‚
                                         â”‚    },                           â”‚
                                         â”‚    "signature": {               â”‚
                                         â”‚      "algorithm": "sha2-256",   â”‚
                                         â”‚      "vault_key": "transit/keys/â”‚
                                         â”‚       profile-signing",         â”‚
                                         â”‚      "signed_at": "2025-11-07T04â”‚
                                         â”‚       :29:31.058861974+00:00",  â”‚
                                         â”‚      "signed_by": "admin@exampleâ”‚
                                         â”‚       .com",                    â”‚
                                         â”‚      "signature": "vault:v1:6wmfâ”‚
                                         â”‚       S0Vo91Ga0E9BkInhWZvLJ3qQodâ”‚
                                         â”‚       EnXhykdywB8kc="           â”‚
                                         â”‚    }                            â”‚
                                         â”‚  }                              â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          â”‚
                                                          â†“
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚  6. Deserialize    â”‚
                                                   â”‚     JSONB â†’ Struct â”‚
                                                   â”‚                    â”‚
                                                   â”‚  profile: Profile =â”‚
                                                   â”‚   serde_json::     â”‚
                                                   â”‚   from_value(      â”‚
                                                   â”‚     config_jsonb   â”‚
                                                   â”‚   )?               â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          â”‚
                                                          â†“
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚  7. Validate       â”‚
                                                   â”‚     (Optional)     â”‚
                                                   â”‚                    â”‚
                                                   â”‚  Phase 6 adds:     â”‚
                                                   â”‚  â€¢ Verify signatureâ”‚
                                                   â”‚    with Vault      â”‚
                                                   â”‚  â€¢ Reject if       â”‚
                                                   â”‚    tampered        â”‚
                                                   â”‚                    â”‚
                                                   â”‚  Phase 5:          â”‚
                                                   â”‚  âœ… Skip verify    â”‚
                                                   â”‚     (dev mode)     â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          â”‚
                                                          â†“
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚  8. Return JSON    â”‚
                                                   â”‚                    â”‚
                                                   â”‚  HTTP 200 OK       â”‚
                                                   â”‚  Content-Type:     â”‚
                                                   â”‚   application/json â”‚
                                                   â”‚                    â”‚
                                                   â”‚  Body: {profile}   â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
  â”‚  Goose       â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚  Desktop     â”‚
  â”‚              â”‚  Step 9: Process Profile
  â”‚  1. Store    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚     profile  â”‚                                     â”‚
  â”‚  2. Request  â”‚                                     â”‚
  â”‚     configs  â”‚                                     â†“
  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                  â”‚  Additional API    â”‚
         â”‚                                  â”‚  Calls:            â”‚
         â”‚                                  â”‚                    â”‚
         â”‚  GET /profiles/finance/config   â”‚  Returns:          â”‚
         â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  config.yaml       â”‚
         â”‚                                  â”‚  (generated from   â”‚
         â”‚                                  â”‚   profile)         â”‚
         â”‚                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                           â”‚
         â”‚                                           â”‚
         â”‚  GET /profiles/finance/goosehints        â”‚
         â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’         â”‚
         â”‚                                  â”‚  Returns:          â”‚
         â”‚                                  â”‚  .goosehints       â”‚
         â”‚                                  â”‚  (from profile.    â”‚
         â”‚                                  â”‚   goosehints.      â”‚
         â”‚                                  â”‚   global)          â”‚
         â”‚                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                           â”‚
         â”‚                                           â”‚
         â”‚  GET /profiles/finance/gooseignore       â”‚
         â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’         â”‚
         â”‚                                  â”‚  Returns:          â”‚
         â”‚                                  â”‚  .gooseignore      â”‚
         â”‚                                  â”‚  (from profile.    â”‚
         â”‚                                  â”‚   gooseignore.     â”‚
         â”‚                                  â”‚   global)          â”‚
         â”‚                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                           â”‚
         â”‚                                           â”‚
         â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Step 10:    â”‚  Save to Local Filesystem
  â”‚  Save Files  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚              â”‚                                    â”‚
  â”‚  Writes:     â”‚                                    â†“
  â”‚  â€¢ ~/.config/goose/config.yaml              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  â€¢ ~/.config/goose/.goosehints              â”‚  Local Files:      â”‚
  â”‚  â€¢ ~/.config/goose/.gooseignore             â”‚                    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚  config.yaml:     â”‚
                                                 â”‚  [profile]         â”‚
                                                 â”‚  [[provider]]      â”‚
                                                 â”‚  provider = "claudeâ”‚
                                                 â”‚   -3.5-sonnet"     â”‚
                                                 â”‚  model = "claude-3.â”‚
                                                 â”‚   5-sonnet"        â”‚
                                                 â”‚                    â”‚
                                                 â”‚  .goosehints:      â”‚
                                                 â”‚  You are assisting â”‚
                                                 â”‚  a finance manager â”‚
                                                 â”‚  ...               â”‚
                                                 â”‚                    â”‚
                                                 â”‚  .gooseignore:     â”‚
                                                 â”‚  *.env             â”‚
                                                 â”‚  *.key             â”‚
                                                 â”‚  .git/             â”‚
                                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Step 11:    â”‚  Goose Ready!
  â”‚  Goose       â”‚  
  â”‚  Desktop     â”‚  âœ… Configured with finance profile
  â”‚              â”‚  âœ… Primary provider: Claude 3.5 Sonnet
  â”‚              â”‚  âœ… Extensions: github
  â”‚              â”‚  âœ… Privacy: Strict (PII masked)
  â”‚              â”‚  âœ… Policies: Allow github tools
  â”‚              â”‚  âœ… Hints: Finance-specific context
  â”‚              â”‚  âœ… Ignore: Protect secrets
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Latency Breakdown (Phase 5 Performance):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step                             â”‚ Latency     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1-3: JWT Verification            â”‚ ~5ms        â”‚
â”‚ 4: Role Matching                 â”‚ <1ms        â”‚
â”‚ 5: Database Query                â”‚ ~3ms        â”‚
â”‚ 6: JSONB Deserialization         â”‚ ~2ms        â”‚
â”‚ 7: Validation (Phase 6)          â”‚ N/A         â”‚
â”‚ 8: JSON Serialization            â”‚ ~2ms        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ Total (P50)                      â”‚ ~13ms       â”‚
â”‚ Target                           â”‚ <20ms       â”‚
â”‚ Performance                      â”‚ âœ… 35% marginâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Design Decisions:**

1. **JWT-Based Auth**: No session storage, stateless verification
2. **Role Extraction**: JWT claims contain user roles, mapped to profiles
3. **JSONB Storage**: Full profile in single JSONB column (fast retrieval, GIN index)
4. **Lazy Validation**: Signature verification deferred to Phase 6 (performance)
5. **Config Generation**: Dynamic YAML/text generation from profile JSON (no duplication)

---

## View 4: Data Flow - Profile Publishing with Vault

### Complete Vault Signing Sequence (D9 Endpoint)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          DATA FLOW: ADMIN PUBLISHES PROFILE (Vault HMAC)             â”‚
â”‚          Endpoint: POST /admin/profiles/{role}/publish               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Admin User  â”‚  Step 1: Publish Request
  â”‚  (Web UI or  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   curl)      â”‚                                            â”‚
  â”‚              â”‚  POST /admin/profiles/finance/publish     â”‚
  â”‚              â”‚  Authorization: Bearer <JWT with admin role>
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â†“
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚  Controller        â”‚
                                                   â”‚  Middleware:       â”‚
                                                   â”‚  1. Verify JWT     â”‚
                                                   â”‚  2. Check role =   â”‚
                                                   â”‚     "admin"        â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          â”‚
                                                          â†“ Authorized âœ…
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚  Handler:          â”‚
                                                   â”‚  publish_profile() â”‚
                                                   â”‚                    â”‚
                                                   â”‚  Step 2:           â”‚
                                                   â”‚  Fetch Profile     â”‚
                                                   â”‚  from Database     â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          â”‚
                                                          â†“
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚  PostgreSQL Query:              â”‚
                                         â”‚                                 â”‚
                                         â”‚  SELECT config                  â”‚
                                         â”‚  FROM profiles                  â”‚
                                         â”‚  WHERE role = 'finance'         â”‚
                                         â”‚                                 â”‚
                                         â”‚  Returns: config JSONB          â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          â”‚
                                                          â†“
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚  Step 3:           â”‚
                                                   â”‚  Prepare Data      â”‚
                                                   â”‚  for Signing       â”‚
                                                   â”‚                    â”‚
                                                   â”‚  1. Remove old sig â”‚
                                                   â”‚     (if exists)    â”‚
                                                   â”‚  2. Serialize to   â”‚
                                                   â”‚     canonical JSON â”‚
                                                   â”‚  3. Sort keys      â”‚
                                                   â”‚     (deterministic)â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          â”‚
                                                          â†“
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚  Canonical JSON:   â”‚
                                                   â”‚                    â”‚
                                                   â”‚  {                 â”‚
                                                   â”‚    "automated_tasksâ”‚
                                                   â”‚     ": [],         â”‚
                                                   â”‚    "description":  â”‚
                                                   â”‚     "Finance Mgr", â”‚
                                                   â”‚    "display_name": â”‚
                                                   â”‚     "Finance Mgr", â”‚
                                                   â”‚    "env_vars": {}, â”‚
                                                   â”‚    "extensions": [ â”‚
                                                   â”‚      ...           â”‚
                                                   â”‚    ],              â”‚
                                                   â”‚    "goosehints": { â”‚
                                                   â”‚      ...           â”‚
                                                   â”‚    },              â”‚
                                                   â”‚    ... (sorted)    â”‚
                                                   â”‚  }                 â”‚
                                                   â”‚                    â”‚
                                                   â”‚  No whitespace     â”‚
                                                   â”‚  variations!       â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          â”‚
                                                          â†“
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚  Step 4:           â”‚
                                                   â”‚  Encode BASE64     â”‚
                                                   â”‚                    â”‚
                                                   â”‚  input = base64::  â”‚
                                                   â”‚   encode(json_str) â”‚
                                                   â”‚                    â”‚
                                                   â”‚  Example:          â”‚
                                                   â”‚  "eyJhdXRvbWF0ZWRfâ”‚
                                                   â”‚   dGFza3MiOltdLC...â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          â”‚
                                                          â†“
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚  Step 5:           â”‚
                                                   â”‚  Call Vault API    â”‚
                                                   â”‚                    â”‚
                                                   â”‚  POST /v1/transit/ â”‚
                                                   â”‚   hmac/profile-    â”‚
                                                   â”‚   signing/sha2-256 â”‚
                                                   â”‚                    â”‚
                                                   â”‚  Headers:          â”‚
                                                   â”‚  X-Vault-Token:    â”‚
                                                   â”‚   $VAULT_TOKEN     â”‚
                                                   â”‚                    â”‚
                                                   â”‚  Body:             â”‚
                                                   â”‚  {                 â”‚
                                                   â”‚    "input": "eyJh..â”‚
                                                   â”‚  }                 â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          â”‚
                                                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          VAULT TRANSIT ENGINE                         â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Step 6: Vault HMAC Computation                                â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚  1. Authenticate Request:                                      â”‚ â”‚
â”‚  â”‚     â€¢ Verify X-Vault-Token (Phase 5: root token)               â”‚ â”‚
â”‚  â”‚     â€¢ Phase 6: Verify AppRole client token                     â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚  2. Decode Input:                                              â”‚ â”‚
â”‚  â”‚     â€¢ BASE64 decode â†’ canonical JSON string                    â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚  3. Retrieve Key:                                              â”‚ â”‚
â”‚  â”‚     â€¢ Load transit/keys/profile-signing                        â”‚ â”‚
â”‚  â”‚     â€¢ Key type: aes256-gcm96 (default for Transit)             â”‚ â”‚
â”‚  â”‚     â€¢ Key version: latest (v1)                                 â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚  4. Compute HMAC:                                              â”‚ â”‚
â”‚  â”‚     â€¢ Algorithm: HMAC-SHA256                                   â”‚ â”‚
â”‚  â”‚     â€¢ Message: canonical JSON (decoded)                        â”‚ â”‚
â”‚  â”‚     â€¢ Key: transit key derivation                              â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚     hmac = HMAC-SHA256(                                        â”‚ â”‚
â”‚  â”‚       key = transit_key,                                       â”‚ â”‚
â”‚  â”‚       message = canonical_json                                 â”‚ â”‚
â”‚  â”‚     )                                                           â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚  5. Encode Signature:                                          â”‚ â”‚
â”‚  â”‚     â€¢ Format: vault:v{version}:{base64_hmac}                   â”‚ â”‚
â”‚  â”‚     â€¢ Example: vault:v1:6wmfS0Vo91Ga0E9BkInhWZvLJ3qQodEnXhykdy â”‚
â”‚  â”‚                wB8kc=                                          â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚  6. Return Response:                                           â”‚ â”‚
â”‚  â”‚     {                                                           â”‚ â”‚
â”‚  â”‚       "data": {                                                â”‚ â”‚
â”‚  â”‚         "hmac": "vault:v1:6wmfS0Vo91Ga0E9BkInhWZvLJ3qQodEnXhy â”‚
â”‚  â”‚                  kdywB8kc="                                    â”‚ â”‚
â”‚  â”‚       }                                                         â”‚ â”‚
â”‚  â”‚     }                                                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                       â”‚
â”‚  Key Management (Phase 5 Dev Mode):                                  â”‚
â”‚  â€¢ Storage: In-memory (ephemeral)                                    â”‚
â”‚  â€¢ Access: Root token (unrestricted)                                 â”‚
â”‚  â€¢ Audit: None                                                       â”‚
â”‚                                                                       â”‚
â”‚  Phase 6 Production:                                                 â”‚
â”‚  â€¢ Storage: Raft (persistent, 3 replicas)                            â”‚
â”‚  â€¢ Access: AppRole (controller-only policy)                          â”‚
â”‚  â€¢ Audit: File device (/vault/logs/audit.log)                        â”‚
â”‚  â€¢ TLS: HTTPS with cert verification                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â†“ vault:v1:6wmfS0Vo...
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚  Step 7:           â”‚
                                     â”‚  Build Signature   â”‚
                                     â”‚  Metadata          â”‚
                                     â”‚                    â”‚
                                     â”‚  signature = {     â”‚
                                     â”‚    algorithm:      â”‚
                                     â”‚     "sha2-256",    â”‚
                                     â”‚    vault_key:      â”‚
                                     â”‚     "transit/keys/ â”‚
                                     â”‚      profile-      â”‚
                                     â”‚      signing",     â”‚
                                     â”‚    signed_at:      â”‚
                                     â”‚     now_utc(),     â”‚
                                     â”‚    signed_by:      â”‚
                                     â”‚     jwt.email,     â”‚
                                     â”‚    signature:      â”‚
                                     â”‚     vault_response â”‚
                                     â”‚  }                 â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â†“
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚  Step 8:           â”‚
                                     â”‚  Update Database   â”‚
                                     â”‚                    â”‚
                                     â”‚  UPDATE profiles   â”‚
                                     â”‚  SET config =      â”‚
                                     â”‚   jsonb_set(       â”‚
                                     â”‚     config,        â”‚
                                     â”‚     '{signature}', â”‚
                                     â”‚     signature_json â”‚
                                     â”‚   ),               â”‚
                                     â”‚   updated_at =     â”‚
                                     â”‚    NOW()           â”‚
                                     â”‚  WHERE role =      â”‚
                                     â”‚   'finance'        â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â†“
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  PostgreSQL: profiles table       â”‚
                          â”‚                                   â”‚
                          â”‚  role='finance'                   â”‚
                          â”‚  config={                         â”‚
                          â”‚    ... (all profile fields)       â”‚
                          â”‚    "signature": {                 â”‚
                          â”‚      "algorithm": "sha2-256",     â”‚
                          â”‚      "vault_key": "transit/keys/  â”‚
                          â”‚       profile-signing",           â”‚
                          â”‚      "signed_at": "2025-11-07T04: â”‚
                          â”‚       29:31.058861974+00:00",     â”‚
                          â”‚      "signed_by": "admin@example. â”‚
                          â”‚       com",                       â”‚
                          â”‚      "signature": "vault:v1:6wmfS0â”‚
                          â”‚       Vo91Ga0E9BkInhWZvLJ3qQodEnXhâ”‚
                          â”‚       ykdywB8kc="                 â”‚
                          â”‚    }                              â”‚
                          â”‚  }                                â”‚
                          â”‚  updated_at='2025-11-07 04:29:31' â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â†“
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚  Step 9:           â”‚
                                     â”‚  Return Response   â”‚
                                     â”‚                    â”‚
                                     â”‚  HTTP 200 OK       â”‚
                                     â”‚  {                 â”‚
                                     â”‚    "message":      â”‚
                                     â”‚     "Profile pub-  â”‚
                                     â”‚      lished",      â”‚
                                     â”‚    "role": "fin",  â”‚
                                     â”‚    "signature": {  â”‚
                                     â”‚      ...           â”‚
                                     â”‚    }               â”‚
                                     â”‚  }                 â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
  â”‚  Admin User  â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚              â”‚
  â”‚  Receives:   â”‚  âœ… Profile published successfully
  â”‚  â€¢ Signature â”‚  âœ… Tamper protection active
  â”‚  â€¢ Metadata  â”‚  âœ… Signed by admin@example.com
  â”‚              â”‚  âœ… Timestamp: 2025-11-07 04:29:31 UTC
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Signature Verification (Phase 6):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  When User Loads Profile (GET /profiles/finance):                    â”‚
â”‚                                                                       â”‚
â”‚  1. Fetch profile from DB (includes signature)                       â”‚
â”‚  2. Extract signature.signature value (vault:v1:...)                 â”‚
â”‚  3. Remove signature field from config                               â”‚
â”‚  4. Serialize config to canonical JSON (same as publish)             â”‚
â”‚  5. Call Vault verify endpoint:                                      â”‚
â”‚     POST /v1/transit/verify/profile-signing/sha2-256                 â”‚
â”‚     {                                                                 â”‚
â”‚       "input": "eyJh...", (BASE64 canonical JSON)                    â”‚
â”‚       "hmac": "vault:v1:6wmfS0Vo..."                                 â”‚
â”‚     }                                                                 â”‚
â”‚  6. Vault returns: {"valid": true}                                   â”‚
â”‚  7. If valid=false: Return 403 Forbidden ("Profile tampered")        â”‚
â”‚  8. If valid=true: Return profile to user                            â”‚
â”‚                                                                       â”‚
â”‚  Tamper Detection:                                                   â”‚
â”‚  â€¢ Manual DB edit of config â†’ HMAC mismatch â†’ 403                    â”‚
â”‚  â€¢ Signature deletion â†’ Missing signature â†’ 403                      â”‚
â”‚  â€¢ Old signature reuse â†’ Content changed â†’ HMAC mismatch â†’ 403       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Latency Breakdown (Publish Operation):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step                                 â”‚ Latency     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1: JWT Verification                  â”‚ ~5ms        â”‚
â”‚ 2: Fetch Profile (DB query)          â”‚ ~3ms        â”‚
â”‚ 3: Serialize to JSON                 â”‚ ~2ms        â”‚
â”‚ 4: BASE64 Encode                     â”‚ <1ms        â”‚
â”‚ 5: HTTP Call to Vault                â”‚ ~8ms        â”‚
â”‚ 6: Vault HMAC Computation            â”‚ ~3ms        â”‚
â”‚ 7: Build Metadata                    â”‚ <1ms        â”‚
â”‚ 8: Update Database (JSONB set)       â”‚ ~4ms        â”‚
â”‚ 9: Response Serialization            â”‚ ~1ms        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ Total (P50)                          â”‚ ~27ms       â”‚
â”‚ Target                               â”‚ <50ms       â”‚
â”‚ Performance                          â”‚ âœ… 46% marginâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Security Guarantees:**

1. **Tamper Detection**: Any config modification â†’ HMAC mismatch â†’ Rejected
2. **Integrity**: Vault key never leaves Vault (HSM-equivalent in prod)
3. **Auditability**: Metadata tracks who signed, when
4. **Non-Repudiation**: Signature proves admin@example.com published
5. **Forward Secrecy**: Phase 6 key rotation invalidates old signatures

**Phase 6 Production Hardening:**

| Feature | Phase 5 (Dev Mode) | Phase 6 (Production) |
|---------|-------------------|----------------------|
| **Transport** | HTTP | HTTPS (TLS 1.3) |
| **Authentication** | Root token (static) | AppRole (rotatable secret_id) |
| **Storage** | In-memory (ephemeral) | Raft (persistent, 3 replicas) |
| **Audit** | None | File device + log rotation |
| **Verification** | Skipped (performance) | Enforced on profile load |
| **Key Protection** | Memory only | Encrypted at rest (Raft) |
| **Unseal** | Auto-unsealed | 3 of 5 keys (Shamir) |

---

## Source Code Architecture

### Service vs. Module Pattern

The `/src` directory contains 6 components organized by architectural pattern:

**Services** (Standalone Docker containers):
1. **controller/** â€” Main API server (port 8088, Rust/Axum)
2. **privacy-guard/** â€” PII detection/masking service (port 8089, Rust)

**Modules** (Rust libraries imported by controller):
3. **lifecycle/** â€” Session state machine (imported via `lib.rs`)
4. **profile/** â€” Profile schema/validation/signing (imported via `lib.rs`)
5. **vault/** â€” HashiCorp Vault client (imported via `lib.rs` and profile module)

**MCP Extensions** (Launched by Goose Desktop):
6. **agent-mesh/** â€” Multi-agent coordination (Python MCP stdio)

### Import Pattern

Controller imports modules via `src/controller/src/lib.rs`:
```rust
// Phase 4: Lifecycle management (lives outside controller for reusability)
#[path = "../../lifecycle/mod.rs"]
pub mod lifecycle;

// Phase 5: Vault client (production-grade HashiCorp Vault integration)
#[path = "../../vault/mod.rs"]
pub mod vault;

// Phase 5: Profile system
#[path = "../../profile/mod.rs"]
pub mod profile;
```

**Usage Examples:**

**lifecycle** â€” Session state machine (Phase 4):
- **Purpose**: Enforce valid state transitions (pending â†’ active â†’ completed/failed/expired)
- **Status**: Infrastructure ready (Phase 6 wiring)
- **Current**: Imported but not yet called in routes (direct DB access in Phase 4)
- **Future**: Phase 6 will wire lifecycle into routes for validation

**profile** â€” Used in route handlers:
```rust
// src/controller/src/routes/profiles.rs
use crate::profile::schema::Profile;

let profile: Profile = serde_json::from_value(data)?;
Ok(Json(profile))
```

**vault** â€” Used by admin routes and profile module:
```rust
// src/controller/src/routes/admin/profiles.rs
use crate::vault::transit::TransitOps;

let transit = TransitOps::new(vault_client);
let signature = transit.sign_data(&profile_data).await?;
```

See **[/src Architecture Audit](SRC-ARCHITECTURE-AUDIT.md)** for complete analysis.

---

## Component Details

### Keycloak (Authentication)

**Role**: OIDC Provider (OAuth 2.0 + OpenID Connect)

**Configuration**:
- Realm: `dev`
- Client: `goose-controller` (PUBLIC client - no client_secret required)
- Flow: Password Grant only (user login with username/password)
  - **Note**: Client Credentials flow NOT supported (public client type)
  - Use `grant_type=password` with user credentials
- Token: JWT (RS256 signature)

**Token Acquisition Example**:
```bash
# Correct (Password Grant)
curl -X POST http://localhost:8080/realms/dev/protocol/openid-connect/token \
  -d "grant_type=password" \
  -d "client_id=goose-controller" \
  -d "username=testuser" \
  -d "password=testpassword"

# Will fail (Client Credentials not supported for public clients)
curl -X POST http://localhost:8080/realms/dev/protocol/openid-connect/token \
  -d "grant_type=client_credentials" \
  -d "client_id=goose-controller" \
  -d "client_secret=..." # No secret for public clients
```

**Users**:
```
testuser / testpassword
  Roles: ["finance", "user"]
  Email: testuser@example.com

admin@example.com
  Roles: ["admin", "user"]
  Email: admin@example.com
```

**Token Claims**:
```json
{
  "sub": "user-id-uuid",
  "email": "testuser@example.com",
  "roles": ["finance", "user"],
  "exp": 1699999999,
  "iat": 1699996399,
  "iss": "http://localhost:8080/realms/dev"
}
```

**JWKS Endpoint**: `http://localhost:8080/realms/dev/protocol/openid-connect/certs`

---

### Privacy Guard (PII Masking)

**Role**: Local PII detection and masking middleware

**Capabilities**:
- 8 entity types: SSN, Email, Phone, Credit Card, Person, IP, DOB, Account
- 25+ regex detection patterns
- Deterministic HMAC-SHA256 pseudonymization
- Format-preserving encryption (FPE) for structured data

**Performance**:
- P50: 16ms
- P95: 22ms
- P99: 23ms
- Target: <700ms (31x better than target)

**Modes**:
- OFF: No masking
- DETECT: Scan only (log entities)
- MASK: Mask PII (default)
- STRICT: Mask + block cloud if local_only=true

**Storage**:
- Local tokens: `~/.goose/pii-tokens/` (ephemeral, per-session)
- No cloud storage (privacy-first)

**Integration**: MCP extension (optional, enabled per profile)

---

### Controller (Orchestration)

**Role**: Central API server (profile management, org chart, audit)

**Language**: Rust (Axum framework)

**Endpoints**: 13 total (D1-D12, E5)

**Middleware**:
- JWT verification (RS256 + JWKS)
- Role extraction (from JWT claims)
- Request logging (structured, PII-redacted)
- CORS (Phase 6: configure for admin UI)

**Performance**:
- Profile loading: P50=13ms (target <20ms)
- Profile publishing: P50=27ms (target <50ms)
- Org chart tree: P50=18ms (target <30ms)

**Database**: PostgreSQL (JSONB for profiles, relational for org chart)

---

### Vault (HMAC Signing)

**Role**: Profile integrity via HMAC signatures

**Configuration** (Phase 5 Dev Mode):
- Image: hashicorp/vault:1.18.3
- Mode: Dev (HTTP, root token, in-memory)
- Transit Engine: Enabled via vault-init.sh
- Key: `profile-signing` (HMAC-SHA256)
- Environment: VAULT_ADDR=http://vault:8200, VAULT_TOKEN=root

**Operations**:
- Sign: POST /v1/transit/hmac/profile-signing/sha2-256
- Verify: POST /v1/transit/verify/profile-signing/sha2-256

**Signature Format**: `vault:v1:{BASE64_HMAC}`

**Phase 6 Production**:
- TLS/HTTPS (2 hours)
- AppRole auth (3 hours)
- Raft storage (2 hours)
- Audit device (1 hour)
- Signature verification (2 hours)

---

### PostgreSQL (Metadata Storage)

**Role**: Profile, org chart, audit trail storage

**Database**: `orchestrator` (not default `postgres`)

**Connection Example**:
```bash
# Correct (specify orchestrator database)
docker exec ce_postgres psql -U postgres -d orchestrator -c "SELECT role FROM profiles;"

# Wrong (will fail - profiles table doesn't exist in postgres database)
docker exec ce_postgres psql -U postgres -c "SELECT role FROM profiles;"
```

**Tables** (Phase 5):

1. **profiles** - Role-based configurations
```sql
CREATE TABLE profiles (
  role VARCHAR(255) PRIMARY KEY,
  display_name VARCHAR(255) NOT NULL,
  data JSONB NOT NULL,  -- All profile config nested here
  signature TEXT,       -- Vault HMAC signature (nullable)
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_profiles_data ON profiles USING GIN (data);

-- Example query (JSONB nested access)
SELECT 
  role,
  display_name,
  (data->>'description') as description,
  (data->'privacy'->>'mode') as privacy_mode,
  (data->'privacy'->>'retention_days')::int as retention_days
FROM profiles
WHERE role = 'finance';
```

2. **org_users** - Organizational hierarchy
```sql
CREATE TABLE org_users (
  employee_id VARCHAR(50) PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(255) NOT NULL,
  manager_email VARCHAR(255),  -- Self-referencing FK
  department VARCHAR(255),
  title VARCHAR(255),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_org_users_email ON org_users(email);
CREATE INDEX idx_org_users_manager ON org_users(manager_email);
CREATE INDEX idx_org_users_dept ON org_users(department);
```

3. **org_imports** - Import audit trail
```sql
CREATE TABLE org_imports (
  id SERIAL PRIMARY KEY,              -- NOT import_id
  filename VARCHAR(255) NOT NULL,
  users_created INTEGER DEFAULT 0,    -- Split metrics
  users_updated INTEGER DEFAULT 0,
  status VARCHAR(50) NOT NULL,
  imported_by VARCHAR(255),
  imported_at TIMESTAMPTZ DEFAULT NOW()
);
```

4. **privacy_audit_logs** - PII detection audit
```sql
CREATE TABLE privacy_audit_logs (
  id BIGSERIAL PRIMARY KEY,
  session_id VARCHAR(255),
  redaction_count INTEGER,
  categories TEXT[],
  mode VARCHAR(50),
  timestamp TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
-- NOTE: tenant_id used in API but NOT stored in logs (privacy requirement)
```

**Legacy Tables** (Phase 1-2):
- audit_events (Phase 1)
- sessions (Phase 1)
- privacy_events (Phase 2)

**Performance**:
- Profile query: ~3ms (JSONB GIN index)
- Org tree query: ~5ms (recursive CTE with manager_email index)

---

## API Endpoint Summary

### Profile Endpoints (Workstream D)

| Endpoint | Method | Auth | Description |
|----------|--------|------|-------------|
| `/profiles/{role}` | GET | User JWT | Load full profile JSON |
| `/profiles/{role}/config` | GET | User JWT | Generate config.yaml |
| `/profiles/{role}/goosehints` | GET | User JWT | Get global hints |
| `/profiles/{role}/goosehints/local` | GET | User JWT | Get local hints template |
| `/profiles/{role}/gooseignore` | GET | User JWT | Get global ignore patterns |
| `/profiles/{role}/recipes` | GET | User JWT | List recipes |
| `/admin/profiles` | POST | Admin JWT | Create new profile |
| `/admin/profiles/{role}` | PUT | Admin JWT | Update profile (partial merge) |
| `/admin/profiles/{role}/publish` | POST | Admin JWT | Sign profile with Vault |

### Org Chart Endpoints (Workstream E)

| Endpoint | Method | Auth | Description |
|----------|--------|------|-------------|
| `/admin/org/import` | POST | Admin JWT | Upload CSV (bulk insert) |
| `/admin/org/imports` | GET | Admin JWT | Import history + audit |
| `/admin/org/tree` | GET | Admin JWT | Hierarchical org structure |

### Infrastructure Endpoints

| Endpoint | Method | Auth | Description |
|----------|--------|------|-------------|
| `/status` | GET | None | Health check |
| `/audit/ingest` | POST | JWT | Audit log ingestion (Phase 1) |

---

## Security Architecture

### Authentication Flow

```
User Login
  â†’ Keycloak OIDC (Password Grant)
    â†’ JWT Token (RS256 signed)
      â†’ Controller verifies with JWKS
        â†’ Extract role from claims
          â†’ Match role to profile
            â†’ Return profile
```

### Authorization Layers

1. **JWT Verification**: RS256 signature + expiration check
2. **Role Extraction**: Map JWT roles to profile roles
3. **Role-Based Access Control (RBAC)**: Admin vs User endpoints
4. **Policy Enforcement** (Phase 3): Tool allowlists/denylists per profile
5. **Vault Integration**: Profile signature verification (Phase 6)

### Privacy Protection

1. **Local-First**: PII masked before cloud LLM calls
2. **Deterministic Masking**: Same PII â†’ Same token (reversible)
3. **Ephemeral Tokens**: Per-session storage, deleted after use
4. **No Cloud Storage**: Tokens never leave local filesystem
5. **Audit Trail**: Privacy events logged (Phase 2)

### Vault Security (Phase 6)

1. **TLS/HTTPS**: Encrypted transport
2. **AppRole Auth**: Scoped permissions (controller-only)
3. **Persistent Storage**: Raft backend (encrypted at rest)
4. **Audit Device**: All operations logged
5. **Key Rotation**: Periodic rotation (90 days)

---

## Phase 6 Preview

### Admin UI (SvelteKit)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ADMIN WEB UI                           â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Dashboard   â”‚  â”‚   Profiles   â”‚  â”‚  Org Chart   â”‚    â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚    â”‚
â”‚  â”‚  â€¢ D3.js     â”‚  â”‚  â€¢ Monaco    â”‚  â”‚  â€¢ CSV       â”‚    â”‚
â”‚  â”‚    Org Chart â”‚  â”‚    Editor    â”‚  â”‚    Import    â”‚    â”‚
â”‚  â”‚  â€¢ Live      â”‚  â”‚  â€¢ Schema    â”‚  â”‚  â€¢ Tree      â”‚    â”‚
â”‚  â”‚    Sessions  â”‚  â”‚    Validationâ”‚  â”‚    Viewer    â”‚    â”‚
â”‚  â”‚  â€¢ Metrics   â”‚  â”‚  â€¢ Publish   â”‚  â”‚  â€¢ Hierarchy â”‚    â”‚
â”‚  â”‚              â”‚  â”‚    Button    â”‚  â”‚    Viz       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Audit Logs  â”‚  â”‚   Settings   â”‚  â”‚  Vault       â”‚    â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚  Status      â”‚    â”‚
â”‚  â”‚  â€¢ Table     â”‚  â”‚  â€¢ Keycloak  â”‚  â”‚              â”‚    â”‚
â”‚  â”‚  â€¢ Filters   â”‚  â”‚  â€¢ Vault     â”‚  â”‚  â€¢ Sealed/   â”‚    â”‚
â”‚  â”‚  â€¢ Export    â”‚  â”‚  â€¢ Database  â”‚  â”‚    Unsealed  â”‚    â”‚
â”‚  â”‚    CSV       â”‚  â”‚  â€¢ Privacy   â”‚  â”‚  â€¢ Key       â”‚    â”‚
â”‚  â”‚              â”‚  â”‚    Guard     â”‚  â”‚    Version   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                            â”‚
â”‚  Authentication: Keycloak OIDC (admin role required)      â”‚
â”‚  API: Controller endpoints (D7-D9, E10-E12)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### User UI (Lightweight)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     USER WEB UI (Phase 6)                  â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  My Profile                                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  Role: Finance Manager                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Primary Provider: Claude 3.5 Sonnet           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Extensions: github                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Privacy: Strict (PII masked)                  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  [Download config.yaml]                â”‚   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  [Download .goosehints]                â”‚   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  [Download .gooseignore]               â”‚   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  My Sessions                                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  Session ID  â”‚  Started At  â”‚  Status  â”‚       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  ses-123     â”‚  2h ago      â”‚  Active  â”‚       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  ses-122     â”‚  5h ago      â”‚  Ended   â”‚       â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                            â”‚
â”‚  Integration: Goose Desktop (download configs)            â”‚
â”‚  Privacy Guard: MCP middleware (optional)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Vault Production (Phase 6)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  VAULT PRODUCTION SETUP                     â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  TLS/HTTPS Setup (2 hours)                           â”‚ â”‚
â”‚  â”‚  â€¢ Generate TLS certs (OpenSSL or Let's Encrypt)     â”‚ â”‚
â”‚  â”‚  â€¢ Update listener config (tls_cert_file)            â”‚ â”‚
â”‚  â”‚  â€¢ Update VAULT_ADDR (https://vault:8200)            â”‚ â”‚
â”‚  â”‚  â€¢ Add VAULT_CACERT (cert verification)              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  AppRole Authentication (3 hours)                     â”‚ â”‚
â”‚  â”‚  â€¢ Enable AppRole auth method                        â”‚ â”‚
â”‚  â”‚  â€¢ Create controller-role (Transit permissions)      â”‚ â”‚
â”‚  â”‚  â€¢ Generate role_id (static), secret_id (rotatable)  â”‚ â”‚
â”‚  â”‚  â€¢ Update controller code (AppRole login)            â”‚ â”‚
â”‚  â”‚  â€¢ Implement token renewal (45-min intervals)        â”‚ â”‚
â”‚  â”‚  â€¢ Remove VAULT_TOKEN from env vars                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Persistent Storage (2 hours)                         â”‚ â”‚
â”‚  â”‚  â€¢ Configure Raft storage backend (3 replicas)       â”‚ â”‚
â”‚  â”‚  â€¢ Initialize Vault (generate unseal keys)           â”‚ â”‚
â”‚  â”‚  â€¢ Unseal procedure (3 of 5 keys)                    â”‚ â”‚
â”‚  â”‚  â€¢ Automate unseal (AWS KMS optional)                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Audit Device (1 hour)                                â”‚ â”‚
â”‚  â”‚  â€¢ Enable file audit device                          â”‚ â”‚
â”‚  â”‚  â€¢ Mount /vault/logs volume                          â”‚ â”‚
â”‚  â”‚  â€¢ Configure log rotation (logrotate)                â”‚ â”‚
â”‚  â”‚  â€¢ Verify all operations logged                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Signature Verification (2 hours)                     â”‚ â”‚
â”‚  â”‚  â€¢ Add verify to profile loading (GET /profiles)     â”‚ â”‚
â”‚  â”‚  â€¢ Implement verify_hmac function (Rust)             â”‚ â”‚
â”‚  â”‚  â€¢ Reject tampered profiles (403 Forbidden)          â”‚ â”‚
â”‚  â”‚  â€¢ Add verify audit logs                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                            â”‚
â”‚  Total Effort: 10 hours (4-6 hours Vault + 2h UI + 2h)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Related Documentation

- **Profile Specification**: [`docs/profiles/SPEC.md`](../profiles/SPEC.md) - Complete schema reference
- **Vault Operations Guide**: [`docs/guides/VAULT.md`](../guides/VAULT.md) - Dev mode + Phase 6 production
- **Migration Guide**: [`docs/MIGRATION-PHASE5.md`](../MIGRATION-PHASE5.md) - Upgrade from v0.4.0
- **Test Results**: [`docs/tests/phase5-test-results.md`](../tests/phase5-test-results.md) - 60/60 tests passing
- **Master Technical Plan**: [`Technical Project Plan/master-technical-project-plan.md`](../../Technical%20Project%20Plan/master-technical-project-plan.md)

---

**Last Updated**: 2025-11-06  
**Version**: v0.5.0  
**Status**: Phase 5 Complete, Phase 6 Planned
